---
title: "RISE Simulation v. 2.0"
author: "John A. Graves"
output:
  html_document:
    code_folding: hide
    toc: yes
    toc_depth: 3
    toc_float:
      collapsed: yes
  html_notebook:
    code_folding: hide
    fig_caption: yes
    toc: yes
    toc_depth: 3
    toc_float:
      collapsed: yes
---

# The Value of Geomic Information

## Visualizing CE of Genetic Testing in a Cost-Effectiveness Plane

```{r blank-ce-plane,echo=FALSE,message=FALSE}
require(ggthemes)

# One indication
# > vogi.none
#      dCOST    dQALY possible     fatal_b       living
# 1 4098.003 22.92677 23.01494 0.006469354 1.216035e-10
# > vogi.single
#      dCOST   dQALY possible     fatal_b       living
# 1 4688.283 22.9329 23.01705 0.006163024 1.216807e-10

# 20 Indications
# > vogi.none20
#      dCOST    dQALY possible   fatal_b       living
# 1 78616.71 20.62479 22.26546 0.1205602 8.977745e-11
# > vogi.single20
#      dCOST    dQALY possible   fatal_b       living
# 1 84948.41 20.73291 22.30471 0.1152217 9.092509e-11
# > 
  
dCost.none1 = 4098
dQALY.none1 = 22.92677
dCost.single1 = 4688.283
dQALY.single1 = 22.9329
dCost.none20 = 78616.71
dQALY.none20 = 20.62479 
dCost.single20 = 84948.41
dQALY.single20 = 20.73291
lambda <- 50000

Means <- data.frame(delta_eff=c(dQALY.single1-dQALY.none1,dQALY.single20-dQALY.none20),
                    delta_cost=c(dCost.single1-dCost.none1,dCost.single20-dCost.none20),
                    scenario = c("Single Indication","20 Indications"))
txtsize <- 12

YLim <- c(-500,7000)
XLim <- c(-.05,.20)
Lambda.Pos <- YLim[2]/lambda

ggplot(Means,aes(x=delta_eff,y=delta_cost,colour=scenario))+geom_blank()+
  theme_tufte()+xlim(XLim)+ylim(YLim)+geom_point()+
  geom_hline(aes(yintercept=0))+geom_vline(aes(xintercept=0))+
  geom_abline(aes(intercept=0,slope=lambda),lty=3)+
  annotate("text",x=Lambda.Pos,y=YLim[2],label= paste0("lambda==50000"),hjust=-.25,parse=T)+
  ylab("Cost Change")+xlab("QALY Change")




```

```{r}


 Means <- CE %>% group_by(Strategy) %>% summarise(
                 N = length(Cost),
                 Cost.mean = mean(Cost),
                 Eff.mean = mean(Effectiveness))  
  #Define ggplot object
  txtsize<-12
  ggplot(CE, aes(x=Effectiveness, y=Cost, color=Strategy)) + 
    geom_point(size=0.7) +
    geom_point(data = Means,aes(x = Eff.mean, y = Cost.mean, shape=Strategy),size=8,fill="white") +
    geom_text(data = Means,aes(x = Eff.mean, y = Cost.mean, label=c(seq(nrow(Means)))),size=5,colour="gray",alpha=1) +
    geom_path(data=df_ell, aes(x=x, y=y,colour=group), size=1, linetype=2, alpha=1) + # draw ellipse lines
    ggtitle("Cost-Effectiveness Scatterplot") +
    scale_colour_discrete(l=50) +  # Use a slightly darker palette than normal
    scale_y_continuous(labels = dollar)+
    scale_x_continuous(breaks=number_ticks(6))+
    theme_bw() +
    theme(legend.position="bottom",legend.title=element_text(size = txtsize),
          legend.key = element_rect(colour = "black"),
          legend.text = element_text(size = txtsize),
          title = element_text(face="bold", size=15),
          axis.title.x = element_text(face="bold", size=txtsize),
          axis.title.y = element_text(face="bold", size=txtsize),
          axis.text.y = element_text(size=txtsize),
          axis.text.x = element_text(size=txtsize))
  
  
```



Our estimate of the VOGI is based on the Net Monetary Benefit (NMB) as a summary measure of cost-effectiveness. NMB is a common metric summarizing (in dollar terms) the health benefits and costs of a given treatment alternative. For treatment option ($\alpha$) and model parameters $\mathbf{\pi} = \{ \pi_1 , ...., \pi_I \}$ π = define:

\[
(1) \quad \quad NMB(\alpha, \mathbf{\pi}) = \lambda \cdot Q(\alpha,\mathbf{\pi}) – C(\alpha, \mathbf{\pi}) 
\]

Where $Q(\alpha, \mathbf{\pi})$ is the QALY measure from the intervention, $C(\alpha, \mathbf{\pi})$ is the cost of the intervention, and $\lambda $ is the fixed value of the marginal societal willingness to pay for an incremental health improvement (i.e., \$50,000/QALY). For a given $ \lambda $ we define the optimal treatment as that which provides the maximum NMB on average:

\[ 
(2) \quad \quad \textrm{max}_\alpha \quad  E_{\mathbf{\pi}}[ \textrm{NMB}(\alpha, \mathbf{\pi})	] 
\]

When estimating equation (2) for the baseline no-genotyping scenario, all model parameters $\mathbf{\pi}=\{ \pi_1,..., \pi_I}$ are held fixed at their mean value.  In other words, we assume that clinical decisions on drug therapy are based on the average population-level risk of an adverse event and not on information on the patient’s individual risk, preferences or characteristics.  

Conversely, to study the value of information we directly model heterogeneity in $\mathbf{\pi}$ by drawing values from the joint probability distribution $p(\mathbf{\pi})$ at each iteration of the model.97 To estimate the EVGT we will utilize genetic data from the simulated patient cohort and model an alternative scenario in which clinicians obtain and act on information on genotype for that patient. The underlying genetic results used for these analyses demonstrate reproducibility of greater than 99%, including greater than 99% concordance and greater than 95% call rate. Under this “perfect information” scenario the physician utilizes information on each patient’s genetic makeup and chooses the optimal drug at the time of initial prescription, thus minimizing the risk of an adverse event. The average NMB under this scenario is value of perfect information on genotype and is given by:

\[
(3) \quad \quad \textrm{E}_{\mathbf{\pi}} [ \textrm{max}_{\alpha} \quad \textrm{NMB}(\alpha, \mathbf{\pi})]
\]

Where the expectation is taken over the joint probability distribution of $\mathbf{\pi}$ (which in this case is simply the distribution of patients with each drug phenotype).  

We obtain an estimate of the EVGT by taking the difference between equations (3) and (2): 

\[
 (4) \quad \quad \textrm{EVGT} =\textrm{E}_{\mathbf{\pi}} [ \textrm{max}_{\alpha} \quad \textrm{NMB}(\alpha, \mathbf{\pi})]- \textrm{max}_\alpha \quad  E_{\mathbf{\pi}}[ \textrm{NMB}(\alpha, \mathbf{\pi})	]
\]

The EVGT provides an estimate of the opportunity cost (in dollar terms) of failing to incorporate genetic information into clinical decisions at the point of prescribing.98  In other words, it tells us maximum society would be willing to pay (per patient) to implement genotype-tailored care.  An estimate of the total amount society (or a payer) would be willing to pay can be obtained by multiplying this value by the total number of patients and by the rate of indication incidence in the population.98 



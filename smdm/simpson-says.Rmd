---
title: 'Half Cycle and Life Tables: What does Simpson say?'
author: "Shawn Garbett MS^[Vanderbilt University Medical Center, Biostatistics]"
date: "September 6, 2018"
output:
  pdf_document: default
  html_document: default
email: shawn.garbett@vumc.org
header-includes:
- \usepackage[LGR,T1]{fontenc}
- \usepackage[utf8]{inputenc}
- \usepackage{textgreek}
- \usepackage{float}
- \usepackage[x11names,dvipsnames,table]{xcolor}
- \usepackage{boldline}
- \usepackage{colortbl}
- \usepackage{hhline}
bibliography: bib.bib
abstract: The half-cycle correction method and the recommended life table membership
  methods are commonly used to numerical compute state membership in discrete Markov
  models in the health economics field. The essence of the problem is numerical integration
  over a fixed interval size. This problem has a rich history dating back to Newton
  and Cotes correspondences, and a better method was published in 1743 by Simpson
  with accompanying proof about expected error of the method. The alternative Simpson
  method is considered state of the art and easy to use. We concludes that both the
  half-cycle correction and life table method should be dropped in favor of the alternative
  Simpson method.
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
library(tangram)
```




Barendregt recommended[@Barendregt2009] banishing the half-cycle correction[@Sonnenberg1993, @Naimark2008] in summing state occupancy in a discrete Markov model, especially in the field of health economics for cost and utility calculations. The recommended solution was to use life tables. The life table method is a restated version of the *trapezoidal rule* which is a closed Newton-Cotes formula.
These methods are foundational in the field of numerical integration (also called quadrature) which numerically computes the area under a curve computed at fixed intervals. In the context of discrete Markov models numerical integration is an estimator of state occupancy or some derived function from that occupancy such as total quality of life (QALY) or total cost typically modified by a discounting function. These methods all assume that the resulting function being integrated is smooth and does not have discontinuities, which fortunately is common for health economic models. These methods were widely used in the 18th and 19th centuries for manual computation and a very common tool of human 'computers'.[@Epperson2007] In this context it is worth understanding the state of the art, it's known error, and limitations. The discovery of the trapezoidal rule has occurred independently in other fields as well.[@Tai1994]

A closed formula uses the end points of the data set and an open formula only uses the interior points. The proposed life table method is none other than the *trapezoidal rule* as proposed by Sir Issac Newton:

$$ \int^{x_2}_{x_1} f(x) dx = \frac{h}{2}[ f(x_1) + f(x_2)] + O(h^3 f'') $$

This formula represents that integration can be approximated for a function $f$ over an interval, $h=x_2 - x_1$, by evaluating the ends points and the resulting error is proportional to the cube of the interval size times the second derivative of the function inside the region. So extending this over several intervals of an evaluated discrete Markov model, the middle intervals weights add to 1 and the end points stay at $\frac{1}{2}$ weight. This is the life table method method.

Such a theory is furthered by Simpson in 1743[@Simpson1743] to Simpson's rule, which didn't have the clean cancellation like the *trapezoidal rule*, and thus Simpson created his $\frac{3}{8}$ rule with a clean set of weights and errors on the order of $O(h^5 f^{(4)})$. Later Boole ^[Sometimes misattributed to Bode from an earlier misprint in [@Abramowitz1965]] extended this further by reducing the error another 2 orders[@Boole1860]. At this point the practice of naming these formulas after their discoverer stopped, but tables of coefficients for higher order versions exist [@Abramowitz1965]. To get the coefficients to come out various alternations of strategies have been explored, and one commonly used accepted for general use in numerical integration for fixed intervals is known as the *alternative extended Simpson's rule*.[@Epperson2007, @Press1992, @Hamming1973]

$$
\begin{split}
\int^{x_n}_{x_1} f(x) dx = & \frac{h}{48} [ 17 f(x_1) + 59 f(x_2) + 43 f(x_3) + 49 f(x_4) + f(x_5) + \\ 
  & \dots + f(x_{n-4}) + 49 f(x_{n-3}) + 43 f(x_{n-2}) + 59 f(x_{n-1}) + 17 f(x_n) ) ] + \\
  O\left(h^5 f^{(4)} \right)
\end{split}
$$

Using the resulting coefficients from this rule reduces overall numerical error greatly compared with the trapezoidal rule in most cases. For an interval size of one it's now dependent on the 4th derivative of the function instead of the 2nd. With well behaved functions, like those commonly found in health economic models the 4th derivative is much smaller than the 2nd. Discounting is easily included by multiplying each time point value by the appropriate discounting function.

Many of the previous discussion has centered on explaining how the half-cycle correction works. This approach doesn't have as simple an explanation without understanding the underlying calculus, but it does come with a mathematical proof of it's properties. A loose conceptual viewpoint of what is happening is that differences of the points can be used to estimate the first derivative, and the differences of those derivative estimates can be used to estimate the 2nd derivative, etc. Each of these estimates provide more information about the shape and curvature of the function being integrated and contribute differing amounts to the final estimate and hence the weighting is determined by the addition of all these contributions, and many terms combine or cancel till a simple weighted sum is all that is required to provide an estimate that achieves acceptable accuracy given the data.

The limitations of this method are that the error is amplified a bit when encountering discontinuities in the integrated function. For example a tunnel state occupancy has a sharp non smooth boundary when it transitions from initial loading to a balance of inflow and outflow. This can occur in Markov models where the tunnel state is initially unoccupied. Further these methods also assume that the function is not "spiky" such as is seen in spectrography data [@Kalambet2018], as this can further reduce numerical accuracy. Fortunately, most health economic models do not fall into this category and the resulting functions are relatively smooth with the exception of the single point when loading a tunnel state.

## Example

This is an extension of the Life Table example from Barendregt[@Barendregt2009] with results compared to the alternative extended Simpson's rule. In this example, we will look at a population of 1000 individuals who are aging from 0 to 10, and we are interested in their total quality of life. The population under consideration has a constant death rate of 0.52. The analytical truth of this model is easily computed as follows.

$$
\int^{10}_0 1000 (1-0.52)^x dx = \left[ 1000 \frac{0.48^x} {\log(0.48)} \right]^{10}_0 \approx  1361.6
$$

```{r, results='asis', echo=FALSE}
# This is for doing numberical integration of a set of numbers at a fixed interval
truth         <- 1000/log(0.48)*(0.48^10 - 0.48^0)
alt_simp_coef <- function(i) c(17, 59, 43, 49, rep(48, i-8), 49, 43, 59, 17) / 48
inst_rate     <- function(percent, timeframe) -log(1-percent) / timeframe

df <- data.frame(Summary=rep(0, 11),
                 Age = 0:10, 
                 Living = round(1000 * 0.48 ^ (0:10), 1), 
                 Trapezoid = c(0.5, rep(1, 9), 0.5))
df$Lx <- round(df$Living * df$Trapezoid, 1)
df$Simpson   = alt_simp_coef(11)
df$Lsim <- round(df$Living * df$Simpson, 1)
df <- rbind(df, colSums(df))

df[13, ] <- c(NA, NA, NA, NA, round(abs(truth - df[12, 5]),1), NA, round(abs(truth - df[12,7]), 1))
df[14, ] <- c(NA, NA, NA, NA, round(100*abs((truth - df[12, 5])/truth),1), NA, round(100*abs((truth - df[12,7])/truth), 1))

df$Simpson <- render_f(df$Simpson, 2)
df$Lx      <- render_f(df$Lx, 1)
df$Lsim    <- render_f(df$Lsim, 1)
df[13, c(1:4, 6)] <- ""
df[14, c(1:4, 6)] <- ""

df$Summary  <- c(rep("", 11), "Sum", "Absolute Error", "Percent Error")



tangram(df, id="tbl1", as.character=TRUE, style="nejm", caption="Barendregt Life Table Compared with Simpson's Method")
```

The Age column is the age of the participants in the population of 1000 over the model run. Living represents the number of living individuals in the model at that age. The trapezoid column is the weights from the trapezoid rule (or life table method). Lx represents the resulting contribution to the summation. The Simpson column is the weighting of the points in the alternative extended Simpson's rule followed by the Lsim which is the total contribution of living to the total life in the model. There are rows showing the summation of the column, and the resulting error from the known analytical truth of the model.

In this simple example the resulting numerical error is reduced by more than an order of magnitude by switching from trapzoidal to Simpson's method!

## Implementation

In R it can easily be implemented as follows:

```
alt_simp_coef <- function(i) c(17, 59, 43, 49, rep(48, i-8), 49, 43, 59, 17) / 48
alt_simp      <- function(x) sum(alt_simp_coef(length(x)) * x)
```

In Excel the following Macro works given a range of values:

```
REM  *****  BASIC  *****

Function Simpson(values As Array)
  
  Dim sum    As Double
  Dim begin  As Long
  Dim final  As Long
  
  begin = LBound(values)
  final = UBound(values)
  
  If final - begin < 8 Then
    Err.Raise 9,"Simpson()","Need 9 or more points to integrate"
  End If

  sum = 0.0
  sum = 17*values(begin  ,1)/48 + _
        59*values(begin+1,1)/48 + _
        43*values(begin+2,1)/48 + _
        49*values(begin+3,1)/48 + _
        49*values(final-3,1)/48 + _
        43*values(final-2,1)/48 + _
        59*values(final-1,1)/48 + _
        17*values(final  ,1)/48
   
  
  For i = begin+4 to final-4
    sum = sum + values(i,1)
  Next

  Simpson = sum

End Function

```

## Conclusion

In conclusion, the field of numerical intergration has long investigated the problem of integrating a function over a fixed interval as provided by the discrete Markov modeling method that is used frequently in health economic models. The idea presented by Barendregt of using Life Tables (or the earlier half-cycle correction) should be called by it's mathematical name, the trapezoidal rule, and is acceptable to improve the accuracy of estimates. If one is in pursuit of higher accuracy the trapezoidal rule should be passed over in favor of the alternative extended Simpson's rule due to it's superior numerical accuracy. It's a simple weighted sum that is easily done with a mathematical proof of behavior. In short Simpson would recommend it.
